import datetime
import math
import os
import sys
import time
from math import atan2, ceil, cos, sin

import cv2
import keyboard
import numpy
import pyautogui
import win32api
import win32con
from PIL import Image

from constants import constants


def orientation(p1: tuple, p2: tuple, p3: tuple):
	val = (float(-p2[1] + p1[1]) * (p3[0] - p2[0])) - (float(p2[0] - p1[0]) * (-p3[1] + p2[1]))
	if val > 0: return 1 #   cw
	elif val < 0: return 2 # ccw
	else: return 0 #         col

def on_segment(start: tuple, end: tuple, point: tuple):
	if point[0] <= max(start[0], end[0]) and point[0] >= min(start[0], end[0]) and point[1] <= max(start[1], end[1]) and point[1] >= min(start[1], end[1]): return True
	else: return False

def lines_intersect(s1: tuple, e1: tuple, s2: tuple, e2: tuple):
	slope_1 = (e1[1] - s1[1]) / (e1[0] - s1[0])
	if slope_1 == 0:
		if s1[1] == s2[1]: return False # Don't include start point
	else:
		intercept_1 = s1[1] / (slope_1 * s1[0])
		y_check = slope_1 * s2[0] + intercept_1
		if y_check == s1[1]: return False # Don't include start point
	o1 = orientation(s1, e1, s2)
	o2 = orientation(s1, e1, e2)
	o3 = orientation(s2, e2, s1)
	o4 = orientation(s2, e2, e1)
	if o1 != o2 and o3 != o4: return True
	elif o1 == 0 and on_segment(s1, e1, s2): return True
	elif o2 == 0 and on_segment(s1, e1, e2): return True
	elif o3 == 0 and on_segment(s2, e2, s1): return True
	elif o4 == 0 and on_segment(s2, e2, e1): return True
	else: return False

def point_in_contour(point: tuple, contour: list):
	end_point = (10000 + constants.video_resolution[0], point[1] + 1)
	intersect_counter = 0
	for i in range(len(contour)):
		start = tuple(contour[i][0])
		k = (i + 1) % len(contour)
		end = tuple(contour[k][0])
		if lines_intersect(point, end_point, start, end):
			if orientation(start, point, end) == 0:
				if on_segment(start, end, point): return True
			intersect_counter += 1
	return intersect_counter % 2 != 0

def move(x: int, y: int):
	win32api.SetCursorPos((x, y))
def unclick():
	win32api.mouse_event(win32con.MOUSEEVENTF_LEFTUP, 0, 0)

def click():
	win32api.mouse_event(win32con.MOUSEEVENTF_LEFTDOWN, 0, 0)

def resize_bigger():
	move(constants.canvas_position[0] + constants.video_resolution[0], constants.canvas_position[1] + constants.video_resolution[1])
	click()
	time.sleep(0.01)
	move(constants.canvas_position[0] + constants.video_resolution[0] + 30, constants.canvas_position[1] + constants.video_resolution[1] + 30)
	time.sleep(0.01)
	unclick()

def resize_smaller():
	move(constants.canvas_position[0] + constants.video_resolution[0] + 30, constants.canvas_position[1] + constants.video_resolution[1] + 30)
	click()
	time.sleep(0.01)
	move(constants.canvas_position[0] + constants.video_resolution[0], constants.canvas_position[1] + constants.video_resolution[1])
	time.sleep(0.01)
	unclick()

def nested_contour(contour: list, contours: list):
	point = tuple(contour[0][0])
	count = 0
	for cont in contours:
		if cont != contour and point_in_contour(point, cont): count += 1
	return count

zero = [[[232, 0]], [[232, 1]], [[233, 2]], [[233, 3]], [[234, 4]], [[233, 5]], [[233, 6]], [[232, 7]], [[232, 11]], [[231, 12]], [[231, 14]], [[232, 15]], [[232, 21]], [[233, 22]], [[233, 23]], [[234, 24]], [[234, 26]], [[235, 27]], [[235, 29]], [[234, 30]], [[234, 38]], [[235, 39]], [[234, 40]], [[235, 41]], [[235, 43]], [[236, 44]], [[236, 46]], [[238, 48]], [[238, 49]], [[240, 51]], [[240, 55]], [[239, 56]], [[240, 57]], [[240, 60]], [[242, 62]], [[242, 66]], [[243, 67]], [[243, 69]], [[244, 70]], [[244, 72]], [[245, 73]], [[245, 74]], [[246, 75]], [[246, 76]], [[247, 76]], [[249, 78]], [[252, 78]], [[253, 79]], [[256, 79]], [[257, 80]], [[261, 80]], [[262, 79]], [[264, 79]], [[265, 78]], [[266, 78]], [[267, 77]], [[271, 77]], [[272, 78]], [[276, 78]], [[277, 77]], [[279, 77]], [[282, 
80]], [[282, 82]], [[281, 83]], [[281, 87]], [[280, 88]], [[280, 90]], [[279, 91]], [[279, 92]], [[275, 96]], [[275, 97]], [[273, 99]], [[273, 100]], [[268, 105]], [[268, 106]], [[264, 110]], [[264, 111]], [[263, 112]], [[263, 113]], [[261, 115]], [[261, 116]], [[259, 118]], [[259, 119]], [[257, 121]], [[257, 122]], [[256, 123]], [[255, 123]], [[256, 124]], [[255, 125]], [[255, 126]], [[254, 127]], [[254, 130]], [[253, 131]], [[253, 134]], [[254, 135]], [[254, 136]], [[255, 137]], [[255, 138]], [[256, 139]], [[256, 140]], [[257, 141]], [[257, 142]], [[259, 144]], [[259, 145]], [[260, 146]], [[264, 146]], [[266, 148]], [[267, 148]], [[268, 149]], [[271, 149]], [[273, 147]], [[274, 147]], [[275, 148]], [[276, 148]], [[277, 149]], [[279, 149]], [[282, 152]], [[283, 152]], [[284, 153]], [[284, 157]], [[285, 158]], [[285, 161]], [[286, 162]], [[286, 169]], [[287, 170]], [[287, 177]], [[288, 178]], [[288, 211]], [[289, 212]], [[289, 221]], [[290, 222]], [[290, 223]], [[289, 224]], [[290, 225]], [[290, 230]], [[291, 231]], [[291, 265]], [[292, 264]], [[292, 263]], [[293, 262]], [[293, 261]], [[294, 260]], [[294, 258]], [[295, 257]], [[295, 255]], [[296, 254]], [[297, 254]], [[298, 255]], 
[[298, 262]], [[299, 263]], [[299, 270]], [[298, 271]], [[299, 272]], [[299, 273]], [[298, 274]], [[298, 291]], [[298, 289]], [[299, 288]], [[300, 288]], [[303, 291]], [[303, 294]], [[302, 295]], [[302, 297]], [[299, 300]], [[298, 300]], [[297, 301]], [[295, 301]], [[292, 304]], [[291, 304]], [[290, 305]], [[289, 305]], [[288, 306]], [[287, 306]], [[285, 308]], [[284, 308]], [[283, 309]], [[282, 309]], [[279, 312]], [[278, 312]], [[276, 314]], [[275, 314]], [[273, 316]], [[272, 316]], [[265, 323]], [[265, 324]], [[261, 328]], [[261, 329]], [[260, 330]], [[260, 331]], [[259, 332]], [[259, 334]], [[258, 335]], [[258, 338]], [[257, 339]], [[257, 343]], [[256, 344]], [[256, 382]], [[255, 383]], [[256, 384]], [[256, 386]], [[255, 387]], [[255, 403]], [[254, 404]], [[254, 411]], [[252, 413]], [[252, 414]], [[249, 417]], [[240, 417]], [[239, 418]], [[238, 417]], [[237, 418]], [[234, 418]], [[233, 419]], [[230, 419]], [[229, 420]], [[228, 420]], [[227, 421]], [[225, 421]], [[222, 424]], [[221, 424]], [[220, 425]], [[220, 426]], [[219, 427]], [[219, 428]], [[218, 429]], [[218, 434]], [[219, 435]], [[219, 437]], [[221, 439]], [[221, 440]], [[225, 444]], [[225, 445]], [[229, 449]], [[229, 450]], [[231, 452]], [[231, 453]], [[232, 454]], [[232, 455]], [[234, 457]], [[234, 458]], [[235, 459]], [[235, 460]], [[236, 461]], [[236, 462]], [[237, 463]], [[237, 475]], [[236, 476]], [[236, 481]], 
[[235, 482]], [[235, 486]], [[234, 487]], [[234, 493]], [[233, 494]], [[233, 501]], [[232, 502]], [[232, 509]], [[231, 510]], [[231, 515]], [[230, 516]], [[230, 521]], [[229, 522]], [[229, 529]], [[228, 530]], [[228, 532]], [[227, 533]], [[227, 536]], [[226, 537]], [[226, 538]], [[225, 539]], [[225, 540]], [[223, 542]], [[223, 543]], [[222, 544]], [[222, 545]], [[221, 546]], [[221, 547]], [[220, 548]], [[220, 549]], [[218, 551]], [[218, 553]], [[217, 554]], [[217, 555]], [[215, 557]], [[215, 558]], [[213, 560]], [[213, 561]], [[212, 562]], [[212, 563]], [[211, 564]], [[211, 565]], [[210, 566]], [[210, 567]], [[209, 568]], [[209, 569]], [[207, 571]], [[207, 572]], [[206, 573]], [[206, 574]], [[205, 575]], [[205, 576]], [[204, 577]], [[204, 578]], [[203, 579]], [[203, 580]], [[202, 581]], [[202, 582]], [[201, 583]], [[201, 584]], [[200, 585]], [[200, 586]], [[198, 588]], [[198, 590]], [[196, 592]], [[196, 593]], [[195, 594]], [[195, 595]], [[194, 596]], [[194, 597]], [[193, 598]], [[193, 599]], [[191, 601]], [[191, 602]], [[190, 603]], [[190, 604]], [[189, 605]], [[189, 606]], [[187, 608]], [[187, 609]], [[186, 610]], [[186, 612]], [[184, 614]], [[184, 615]], [[183, 616]], [[183, 617]], [[182, 618]], [[182, 619]], [[181, 620]], [[181, 621]], [[180, 622]], [[180, 623]], [[179, 624]], [[179, 625]], [[178, 626]], [[178, 627]], [[176, 629]], [[176, 630]], [[175, 631]], [[175, 632]], 
[[174, 633]], [[174, 634]], [[173, 635]], [[173, 636]], [[172, 637]], [[172, 638]], [[170, 640]], [[170, 641]], [[169, 642]], [[169, 643]], [[168, 644]], [[168, 645]], [[167, 646]], [[167, 647]], [[166, 648]], [[166, 649]], [[164, 651]], [[164, 653]], [[162, 655]], [[162, 656]], [[161, 657]], [[161, 658]], [[159, 660]], [[159, 662]], [[157, 664]], [[157, 665]], [[156, 666]], [[156, 667]], [[155, 668]], [[155, 669]], [[154, 670]], [[154, 671]], [[153, 672]], [[153, 673]], [[152, 674]], [[152, 675]], [[151, 676]], [[151, 677]], [[150, 678]], [[150, 679]], [[149, 680]], [[149, 681]], [[148, 682]], [[148, 684]], [[151, 687]], [[151, 688]], [[154, 691]], [[155, 691]], [[157, 693]], [[157, 694]], [[158, 695]], [[159, 695]], [[160, 696]], [[160, 697]], [[161, 697]], [[165, 701]], [[165, 702]], [[166, 703]], [[166, 707]], [[165, 708]], [[165, 711]], [[164, 712]], [[164, 716]], [[163, 717]], [[163, 719]], [[656, 719]], [[656, 718]], [[657, 717]], [[657, 714]], [[658, 713]], [[658, 711]], [[659, 710]], [[659, 698]], [[658, 697]], [[658, 695]], [[657, 694]], [[657, 691]], [[656, 690]], [[656, 688]], [[655, 687]], [[655, 684]], [[654, 683]], [[654, 682]], [[653, 681]], [[653, 679]], [[652, 678]], [[652, 676]], [[651, 675]], [[651, 672]], [[649, 670]], [[649, 668]], [[648, 667]], [[648, 666]], [[647, 665]], [[647, 664]], [[646, 663]], [[646, 661]], [[645, 660]], [[645, 658]], [[644, 657]], 
[[644, 653]], [[645, 652]], [[645, 650]], [[646, 649]], [[646, 647]], [[647, 646]], [[647, 643]], [[648, 642]], [[648, 639]], [[649, 638]], [[649, 636]], [[650, 635]], [[650, 633]], [[651, 632]], [[651, 630]], [[652, 629]], [[652, 627]], [[653, 626]], [[653, 622]], [[654, 621]], [[654, 615]], [[653, 614]], [[653, 613]], [[652, 612]], [[652, 611]], [[651, 610]], [[651, 608]], [[649, 606]], [[649, 605]], [[648, 604]], [[648, 603]], [[647, 602]], [[647, 601]], [[646, 600]], [[646, 599]], [[645, 598]], [[645, 597]], [[644, 596]], [[644, 594]], [[643, 593]], [[643, 592]], [[642, 591]], [[642, 590]], [[640, 588]], [[640, 587]], [[639, 586]], [[639, 584]], [[638, 583]], [[638, 582]], [[637, 581]], [[637, 580]], [[636, 579]], [[636, 577]], [[634, 575]], [[634, 573]], [[633, 572]], [[633, 571]], [[632, 570]], [[632, 569]], [[631, 568]], [[631, 567]], [[630, 566]], [[630, 565]], [[629, 564]], [[629, 563]], [[628, 562]], [[628, 561]], [[627, 560]], [[627, 559]], [[626, 558]], [[626, 556]], [[625, 555]], [[625, 554]], [[624, 553]], [[624, 552]], [[623, 551]], [[623, 550]], [[622, 549]], [[622, 547]], [[621, 546]], [[621, 545]], [[620, 544]], [[620, 543]], [[619, 542]], [[619, 541]], [[618, 540]], [[618, 539]], [[617, 538]], [[617, 536]], [[616, 535]], [[616, 534]], [[615, 533]], [[615, 532]], [[614, 531]], [[614, 529]], [[613, 528]], [[613, 527]], [[612, 526]], [[612, 524]], [[611, 523]], 
[[611, 522]], [[610, 521]], [[610, 519]], [[609, 518]], [[609, 517]], [[608, 516]], [[608, 514]], [[607, 513]], [[607, 512]], [[606, 511]], [[606, 509]], [[605, 508]], [[605, 507]], [[604, 506]], [[604, 504]], [[603, 503]], [[603, 501]], [[602, 500]], [[602, 499]], [[601, 498]], [[601, 496]], [[600, 495]], [[600, 494]], [[599, 493]], [[599, 492]], [[598, 491]], [[598, 490]], [[597, 489]], [[597, 488]], [[596, 487]], [[596, 486]], [[595, 485]], [[595, 483]], [[594, 482]], [[594, 481]], [[593, 480]], [[593, 478]], [[592, 477]], [[592, 475]], [[591, 474]], [[591, 472]], [[590, 471]], [[590, 470]], [[589, 469]], [[589, 468]], [[588, 467]], [[588, 465]], [[587, 464]], [[587, 463]], [[586, 462]], [[586, 460]], [[585, 459]], [[585, 458]], [[584, 457]], [[584, 455]], [[583, 454]], [[583, 453]], [[582, 452]], [[582, 451]], [[581, 450]], [[581, 448]], [[580, 447]], [[580, 446]], [[579, 445]], [[579, 443]], [[577, 441]], [[577, 440]], [[576, 439]], [[576, 438]], [[575, 437]], [[575, 434]], [[577, 432]], [[577, 431]], [[580, 428]], [[580, 427]], [[581, 426]], [[581, 425]], [[582, 424]], [[582, 423]], [[583, 422]], [[583, 420]], [[584, 419]], [[584, 417]], [[585, 416]], [[585, 413]], [[586, 412]], [[586, 410]], [[587, 409]], [[587, 404]], [[586, 403]], [[586, 401]], [[585, 400]], [[585, 398]], [[584, 397]], [[584, 395]], [[583, 394]], [[583, 393]], [[577, 387]], [[576, 387]], [[574, 385]], 
[[573, 385]], [[572, 384]], [[571, 384]], [[570, 383]], [[567, 383]], [[566, 382]], [[564, 382]], [[563, 381]], [[555, 381]], [[554, 380]], [[550, 380]], [[549, 379]], [[548, 379]], [[547, 378]], [[547, 377]], [[546, 376]], [[546, 373]], [[545, 372]], [[545, 368]], [[544, 367]], [[544, 363]], [[543, 362]], [[543, 357]], [[542, 356]], [[542, 353]], [[541, 352]], [[541, 348]], [[540, 347]], [[540, 344]], [[539, 343]], [[539, 338]], [[538, 337]], [[538, 336]], [[537, 335]], [[537, 333]], [[536, 332]], [[536, 330]], [[535, 329]], [[535, 327]], [[534, 326]], [[534, 325]], [[532, 323]], [[532, 322]], [[531, 321]], [[531, 320]], [[529, 318]], [[529, 317]], [[528, 316]], [[527, 316]], [[525, 314]], [[525, 313]], [[519, 307]], [[518, 307]], [[514, 303]], [[514, 283]], [[517, 280]], [[518, 280]], [[519, 279]], [[520, 279]], [[520, 275]], [[519, 274]], [[519, 273]], [[518, 272]], [[518, 248]], [[517, 247]], [[517, 237]], [[516, 236]], [[516, 223]], [[515, 222]], [[515, 218]], [[516, 217]], [[516, 214]], [[517, 213]], [[517, 211]], [[516, 210]], [[515, 211]], [[513, 211]], [[509, 207]], [[509, 191]], [[510, 190]], [[510, 189]], [[512, 187]], [[512, 186]], [[515, 183]], [[514, 184]], [[513, 184]], [[512, 183]], [[513, 182]], [[513, 181]], [[516, 178]], [[517, 178]], [[518, 179]], [[517, 180]], [[517, 181]], [[520, 178]], [[521, 178]], [[522, 177]], [[522, 176]], [[523, 175]], [[524, 175]], 
[[524, 174]], [[526, 172]], [[526, 171]], [[527, 170]], [[527, 169]], [[528, 168]], [[528, 166]], [[529, 165]], [[529, 164]], [[530, 163]], [[530, 161]], [[531, 160]], [[531, 158]], [[532, 157]], [[532, 155]], [[533, 154]], [[533, 151]], [[534, 150]], [[534, 120]], [[533, 119]], [[533, 113]], [[532, 112]], [[532, 110]], [[533, 109]], [[536, 109]], [[538, 111]], [[539, 111]], [[540, 112]], [[542, 112]], [[543, 113]], [[547, 113]], [[548, 114]], [[555, 114]], [[559, 110]], [[559, 109]], [[560, 108]], [[560, 107]], [[563, 104]], [[563, 103]], [[565, 101]], [[565, 100]], [[566, 99]], [[566, 97]], 
[[567, 96]], [[567, 93]], [[570, 90]], [[571, 90]], [[571, 89]], [[573, 87]], [[573, 86]], [[574, 85]], [[574, 82]], [[576, 80]], [[576, 75]], [[577, 74]], [[577, 73]], [[580, 70]], [[580, 69]], [[581, 68]], [[581, 67]], [[582, 66]], [[582, 65]], [[583, 64]], [[583, 53]], [[586, 50]], [[587, 50]], [[588, 49]], [[588, 48]], [[589, 47]], [[589, 42]], [[590, 41]], [[590, 40]], [[591, 39]], [[591, 31]], [[593, 29]], [[594, 29]], [[596, 27]], [[596, 26]], [[597, 25]], [[597, 24]], [[598, 23]], [[598, 22]], [[599, 21]], [[599, 18]], [[598, 17]], [[598, 16]], [[599, 15]], [[599, 14]], [[603, 10]], [[603, 9]], [[604, 8]], [[603, 7]], [[603, 0]]]
one = [[[311, 622]], [[312, 623]], [[312, 639]], [[313, 640]], [[313, 643]], [[312, 644]], [[312, 645]], [[311, 646]], [[311, 648]], [[309, 650]], [[309, 651]], [[306, 654]], [[305, 653]], [[305, 649]], [[306, 648]], [[306, 646]], [[307, 645]], [[307, 638]], [[308, 637]], [[308, 632]], [[309, 631]], [[309, 624]]]

print(f'zero: {nested_contour(zero, [zero, one])}, {nested_contour(zero, [zero, one]) % 2 == 0}')
print(f'one: {nested_contour(one, [zero, one])}, {nested_contour(one, [zero, one]) % 2 == 0}')