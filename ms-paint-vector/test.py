import datetime
import math
import os
import sys
import time
from math import atan2, ceil, cos, sin

import cv2
import keyboard
import numpy
import pyautogui
import win32api
import win32con
from PIL import Image

from constants import constants


def orientation(p1: tuple, p2: tuple, p3: tuple):
	val = (float(-p2[1] + p1[1]) * (p3[0] - p2[0])) - (float(p2[0] - p1[0]) * (-p3[1] + p2[1]))
	if val > 0: return 1 #   cw
	elif val < 0: return 2 # ccw
	else: return 0 #         col

def on_segment(start: tuple, end: tuple, point: tuple):
	if point[0] <= max(start[0], end[0]) and point[0] >= min(start[0], end[0]) and point[1] <= max(start[1], end[1]) and point[1] >= min(start[1], end[1]): return True
	else: return False

def lines_intersect(s1: tuple, e1: tuple, s2: tuple, e2: tuple):
	slope_1 = (e1[1] - s1[1]) / (e1[0] - s1[0])
	if slope_1 == 0:
		if s1[1] == s2[1]: return False # Don't include start point
	else:
		intercept_1 = s1[1] / (slope_1 * s1[0])
		y_check = slope_1 * s2[0] + intercept_1
		if y_check == s1[1]: return False # Don't include start point
	o1 = orientation(s1, e1, s2)
	o2 = orientation(s1, e1, e2)
	o3 = orientation(s2, e2, s1)
	o4 = orientation(s2, e2, e1)
	if o1 != o2 and o3 != o4: return True
	elif o1 == 0 and on_segment(s1, e1, s2): return True
	elif o2 == 0 and on_segment(s1, e1, e2): return True
	elif o3 == 0 and on_segment(s2, e2, s1): return True
	elif o4 == 0 and on_segment(s2, e2, e1): return True
	else: return False

def point_in_contour(point: tuple, contour: list):
	end_point = (10000 + constants.video_resolution[0], point[1] + 1)
	intersect_counter = 0
	for i in range(len(contour)):
		start = tuple(contour[i][0])
		k = (i + 1) % len(contour)
		end = tuple(contour[k][0])
		if lines_intersect(point, end_point, start, end):
			if orientation(start, point, end) == 0:
				if on_segment(start, end, point): return True
			intersect_counter += 1
	return intersect_counter % 2 != 0

square = [[[10, 10]], [[20, 10]], [[20, 20]], [[10, 20]]]
annoying_shape = [[[756, 663]], [[755, 664]], [[757, 666]], [[757, 668]], [[758, 669]], [[758, 670]], [[759, 671]], [[759, 672]], [[762, 675]], [[762, 676]], [[767, 681]], [[768, 681]], [[771, 684]], [[772, 684]], [[774, 686]], [[775, 686]], [[776, 687]], [[777, 687]], [[778, 686]], [[779, 686]], [[779, 682]], [[778, 681]], [[778, 680]], [[777, 679]], [[777, 678]], [[775, 676]], [[775, 675]], [[771, 
671]], [[771, 670]], [[770, 669]], [[769, 669]], [[768, 668]], [[767, 668]], [[764, 665]], [[762, 665]], [[761, 664]], [[757, 664]]]
annoying_shape_part_2 = [[[611, 654]], [[610, 655]], [[609, 655]], [[608, 656]], [[608, 659]], [[609, 660]], [[609, 661]], [[611, 663]], [[623, 663]], [[625, 661]], [[626, 661]], [[628, 659]], [[628, 658]], [[627, 657]], [[626, 657]], [[624, 655]], [[622, 655]], [[621, 654]]]
point = (614, 658)
annoying_shape_part_3 = [[[644, 562]], [[643, 563]], [[640, 563]], [[640, 565]], [[639, 566]], [[639, 567]], [[638, 568]], [[638, 569]], [[637, 570]], [[637, 572]], [[639, 574]], [[641, 574]], [[642, 575]], [[644, 575]], [[645, 574]], [[647, 574]], [[648, 573]], [[648, 571]], [[647, 570]], [[647, 569]], [[645, 567]], [[645, 564]], [[644, 563]]]
annoying = [[[484, 223]], [[485, 224]], [[485, 235]], [[484, 236]], [[484, 249]], [[483, 250]], [[483, 258]], [[482, 259]], [[481, 258]], [[481, 256]], [[480, 255]], [[480, 248]], [[479, 247]], [[479, 242]], [[478, 241]], [[478, 230]], [[479, 229]], [[479, 228]]]
absolutely_annoying = [[[586, 539]], [[584, 541]], [[585, 542]], [[585, 543]], [[586, 544]], [[586, 548]], [[587, 549]], [[587, 550]], [[588, 551]], [[588, 552]], [[589, 553]], [[589, 556]], [[590, 557]], [[590, 559]], [[591, 560]], [[591, 564]], [[592, 565]], [[592, 568]], [[593, 569]], [[593, 572]], [[594, 573]], [[594, 574]], [[595, 575]], [[595, 578]], [[596, 579]], [[596, 582]], [[597, 583]], [[597, 586]], [[598, 
587]], [[598, 590]], [[599, 591]], [[599, 593]], [[600, 594]], [[600, 597]], [[601, 598]], [[601, 600]], [[602, 601]], [[602, 604]], [[603, 605]], [[603, 607]], [[604, 608]], [[604, 609]], [[605, 610]], [[605, 612]], [[606, 613]], [[606, 616]], [[607, 617]], [[607, 618]], [[608, 619]], [[608, 622]], [[609, 623]], [[609, 624]], [[610, 625]], [[610, 627]], [[611, 628]], [[611, 630]], [[612, 631]], [[612, 633]], [[613, 634]], [[613, 636]], [[614, 637]], [[614, 639]], [[615, 640]], [[615, 643]], [[616, 644]], [[616, 646]], [[617, 647]], [[617, 648]], [[618, 649]], [[618, 651]], [[619, 652]], [[619, 654]], [[620, 655]], [[620, 657]], [[621, 658]], [[621, 660]], [[622, 661]], [[622, 663]], [[623, 664]], [[623, 666]], [[624, 667]], [[624, 669]], [[625, 670]], [[625, 672]], [[626, 673]], [[626, 674]], [[627, 675]], [[627, 678]], [[628, 679]], [[628, 681]], [[629, 682]], [[629, 683]], [[630, 684]], [[630, 687]], [[631, 688]], [[631, 690]], [[632, 691]], [[632, 694]], [[633, 695]], [[633, 696]], [[634, 697]], [[634, 699]], [[635, 700]], [[635, 703]], [[636, 704]], [[636, 706]], [[637, 707]], [[637, 709]], [[638, 710]], [[638, 712]], [[639, 713]], [[639, 715]], [[640, 716]], [[640, 717]], [[641, 718]], [[641, 719]], [[681, 719]], [[682, 718]], [[682, 704]], [[670, 692]], [[670, 691]], [[666, 687]], [[666, 686]], [[665, 686]], [[664, 685]], [[664, 684]], [[659, 679]], [[659, 678]], [[653, 
672]], [[653, 671]], [[649, 667]], [[649, 666]], [[646, 663]], [[646, 662]], [[642, 658]], [[642, 657]], [[639, 654]], [[639, 653]], [[636, 650]], [[636, 649]], [[634, 647]], [[634, 646]], [[631, 643]], [[631, 642]], [[629, 640]], [[629, 639]], [[627, 637]], [[627, 636]], [[625, 634]], [[625, 633]], [[624, 632]], [[624, 631]], [[622, 629]], [[622, 628]], [[621, 627]], [[621, 626]], [[619, 624]], [[619, 623]], [[618, 622]], [[618, 621]], [[616, 619]], [[616, 618]], [[615, 617]], [[615, 616]], [[614, 615]], [[614, 614]], [[613, 613]], [[613, 612]], [[612, 611]], [[612, 609]], [[611, 608]], [[611, 607]], [[610, 606]], [[610, 605]], [[609, 604]], [[609, 603]], [[608, 602]], [[608, 601]], [[607, 600]], [[607, 598]], [[606, 597]], [[606, 596]], [[605, 595]], [[605, 593]], [[604, 592]], [[604, 591]], [[603, 590]], [[603, 587]], [[602, 586]], [[602, 585]], [[601, 584]], [[601, 582]], [[600, 581]], [[600, 580]], [[599, 579]], [[599, 575]], [[598, 574]], [[598, 573]], [[597, 572]], [[597, 570]], [[596, 569]], [[596, 567]], [[595, 566]], [[595, 562]], [[594, 561]], [[594, 558]], [[593, 557]], [[593, 554]], [[592, 553]], [[592, 550]], [[591, 549]], [[591, 546]], [[590, 545]], [[590, 543]], [[589, 542]], [[589, 541]], [[587, 539]]]
annoying_ellipse = [[[439, 289]], [[438, 290]], [[430, 290]], [[429, 291]], [[423, 291]], [[422, 292]], [[418, 292]], [[417, 293]], [[413, 293]], [[412, 294]], [[409, 294]], [[408, 295]], [[405, 295]], [[404, 296]], [[401, 296]], [[400, 297]], [[398, 297]], [[397, 298]], [[395, 298]], [[394, 299]], [[392, 299]], [[391, 300]], [[390, 300]], [[389, 301]], [[387, 301]], [[386, 302]], [[385, 302]], [[384, 303]], [[383, 
303]], [[382, 304]], [[381, 304]], [[380, 305]], [[379, 305]], [[378, 306]], [[377, 306]], [[376, 307]], [[375, 307]], [[374, 308]], [[373, 308]], [[372, 309]], [[371, 309]], [[370, 310]], [[369, 310]], [[367, 312]], [[366, 312]], [[364, 314]], [[363, 314]], [[361, 316]], [[360, 316]], [[357, 319]], [[356, 319]], [[349, 326]], [[348, 326]], [[346, 328]], [[346, 329]], [[340, 335]], [[340, 336]], [[338, 338]], [[338, 339]], [[335, 342]], [[335, 343]], [[334, 344]], [[334, 345]], [[333, 346]], [[333, 347]], [[332, 348]], [[332, 349]], [[331, 350]], [[331, 351]], [[330, 352]], [[330, 354]], [[329, 355]], [[329, 356]], [[328, 357]], [[328, 359]], [[327, 360]], [[327, 364]], [[326, 365]], [[326, 370]], [[325, 371]], [[325, 383]], [[326, 384]], [[326, 389]], [[327, 390]], [[327, 394]], [[328, 395]], [[328, 397]], [[329, 398]], [[329, 399]], [[330, 400]], [[330, 402]], [[331, 403]], [[331, 404]], [[332, 405]], [[332, 406]], [[333, 407]], [[333, 408]], [[334, 409]], [[334, 410]], [[335, 411]], [[335, 412]], [[337, 414]], [[337, 415]], [[340, 418]], [[340, 419]], [[345, 424]], [[345, 425]], [[349, 429]], [[350, 429]], [[356, 435]], [[357, 435]], [[360, 438]], [[361, 438]], [[363, 440]], [[364, 440]], [[366, 442]], [[367, 442]], [[369, 444]], [[370, 444]], [[371, 445]], [[372, 445]], [[373, 446]], [[374, 446]], [[375, 447]], [[376, 447]], [[378, 449]], [[379, 449]], [[380, 450]], [[382, 
450]], [[383, 451]], [[384, 451]], [[385, 452]], [[386, 452]], [[387, 453]], [[389, 453]], [[390, 454]], [[391, 454]], [[392, 455]], [[394, 455]], [[395, 456]], [[397, 456]], [[398, 457]], [[400, 457]], [[401, 458]], [[404, 458]], [[405, 459]], [[407, 459]], [[408, 460]], [[411, 460]], [[412, 461]], [[416, 461]], [[417, 462]], [[422, 462]], [[423, 463]], [[428, 463]], [[429, 464]], [[438, 464]], [[439, 465]], [[465, 465]], [[466, 464]], [[475, 464]], [[476, 463]], [[481, 463]], [[482, 462]], [[487, 462]], [[488, 461]], [[492, 461]], [[493, 460]], [[496, 460]], [[497, 459]], [[500, 459]], [[501, 458]], [[503, 458]], [[504, 457]], [[506, 457]], [[507, 456]], [[509, 456]], [[510, 455]], [[512, 455]], [[513, 454]], [[514, 454]], [[515, 453]], [[517, 453]], [[518, 452]], [[519, 452]], [[520, 451]], [[522, 451]], [[523, 450]], [[524, 450]], [[525, 449]], [[526, 449]], [[527, 448]], [[528, 448]], [[530, 446]], [[531, 446]], [[532, 445]], [[533, 445]], [[534, 444]], [[535, 444]], [[537, 442]], [[538, 442]], [[539, 441]], [[540, 441]], [[542, 439]], [[543, 439]], [[547, 435]], [[548, 435]], [[553, 430]], [[554, 430]], [[559, 425]], [[559, 424]], [[565, 418]], [[565, 417]], [[567, 415]], [[567, 414]], [[569, 412]], [[569, 411]], [[570, 410]], [[570, 409]], [[571, 408]], [[571, 407]], [[572, 406]], [[572, 405]], [[573, 404]], [[573, 403]], [[574, 402]], [[574, 401]], [[575, 400]], [[575, 
398]], [[576, 397]], [[576, 395]], [[577, 394]], [[577, 390]], [[578, 389]], [[578, 385]], [[579, 384]], [[579, 370]], [[578, 369]], [[578, 365]], [[577, 364]], [[577, 360]], [[576, 359]], [[576, 357]], [[575, 356]], [[575, 355]], [[574, 354]], [[574, 352]], [[573, 351]], [[573, 350]], [[572, 349]], [[572, 348]], [[571, 347]], [[571, 346]], [[570, 345]], [[570, 344]], [[569, 343]], [[569, 342]], [[567, 340]], [[567, 339]], [[564, 336]], [[564, 335]], [[559, 330]], [[559, 329]], [[555, 325]], [[554, 325]], [[548, 319]], [[547, 319]], [[544, 316]], [[543, 316]], [[540, 313]], [[539, 313]], [[538, 312]], [[537, 312]], [[535, 310]], [[534, 310]], [[533, 309]], [[532, 309]], [[531, 308]], [[530, 308]], [[529, 307]], [[528, 307]], [[527, 306]], [[526, 306]], [[525, 305]], [[524, 305]], [[523, 304]], [[522, 304]], [[521, 303]], [[520, 303]], [[519, 302]], [[518, 302]], [[517, 301]], [[515, 301]], [[514, 300]], [[513, 300]], [[512, 299]], [[510, 299]], [[509, 298]], [[507, 298]], [[506, 297]], [[504, 297]], [[503, 296]], [[500, 296]], [[499, 295]], [[496, 295]], [[495, 294]], [[492, 294]], [[491, 293]], [[488, 293]], [[487, 292]], [[482, 292]], [[481, 291]], [[475, 291]], [[474, 290]], [[466, 290]], [[465, 289]]]
sussy_rect = [[[416, 507]], [[416, 560]], [[568, 560]], [[568, 507]]]
# 394 62, 389 62
# print(len(bitchy_shape_part_2))
# print(on_segment(tuple(bitchy_shape[757][0]), tuple(bitchy_shape[758][0]), point))
# print(lines_intersect(point, (-1, -1), (10, 10), (20, 10)))
# print(orientation(point, (-1, -1), (10, 10)))
# print(f'orientation: {orientation(tuple(sussy_rect[0][0]), tuple(sussy_rect[1][0]), tuple(sussy_rect[2][0]))}')
# print(f'orientation: {orientation((), tuple(absolutely_annoying[1][0]), tuple(absolutely_annoying[2][0]))}')
i = 0
perp_off = -math.pi / 2
pt1 = tuple(sussy_rect[i][0])
pt2 = tuple(sussy_rect[(i + 1) % len(sussy_rect)][0])
ang = atan2(-(pt2[1] - pt1[1]), pt2[0] - pt1[0])
perp_ang = ang + perp_off
# if perp_ang < 0:
# 	perp_ang += math.pi * 2
x_off = ceil(constants.brush_size_offset / 2) * cos(perp_ang)
y_off = -ceil(constants.brush_size_offset / 2) * sin(perp_ang)
midpoint = ((pt1[0] + pt2[0]) / 2, (pt1[1] + pt2[1]) / 2)
check_point = (round(midpoint[0] + x_off), round(midpoint[1] + y_off))
# print(ang * 180 / math.pi)
# print(perp_ang * 180 / math.pi)
# print(x_off)
# print(y_off)
print(pt1)
print(pt2)
print(check_point)
print(point_in_contour(check_point, sussy_rect))


frame_folder_path = os.getcwd()[:os.getcwd().rfind('\\')] + '\\frame-sequence\\'
frame = 1546
mat = cv2.imread(frame_folder_path + f'{frame:04}.png', 0)
ret, mat = cv2.threshold(mat, 100, 255, 0)
if not ret:
	print('Error: Threshold failed')
	sys.exit()
print(mat[check_point[1]][check_point[0]])
